<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSC 225 – Lab 6: Consuming a REST API</title>
<style>
:root { --maxw: 920px; }
body { font-family: Bahnschrift, "Segoe UI", Arial, Helvetica, sans-serif; margin: 2rem; line-height: 1.5; }
.container { max-width: var(--maxw); margin: 0 auto; }
h1 { margin: 0 0 0.5rem; }
p.lead { margin: 0 0 1rem; color: #444; }
.actions { display: flex; gap: .75rem; align-items: center; margin: 1rem 0 1.25rem; }
button { cursor: pointer; border: 0; background: #0d6efd; color: #fff; padding: .6rem .9rem; border-radius: .5rem; font-size: 1rem; }
button:active { transform: translateY(1px); }
img { display:block; max-width:100%; height:auto; border-radius: .75rem; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
figure { margin: 0 0 1rem; }
figcaption { font-size: .9rem; color:#555; margin-top: .4rem; }
table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
thead th { text-align: left; background:#f5f7fb; }
th, td { padding: .65rem .7rem; border-bottom: 1px solid #e9eef5; vertical-align: top; }
.muted { color: #555; }
.status { font-size: .9rem; color: #444; }
.error { color: #b00020; font-weight: 600; }
.sr-only { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>Lab 6 – Consuming a REST API</h1>
<p class="lead">When you click this button, an image will appear and facts will pop up!</p>
</header>

<figure>
<img id="catPhoto" src="myphoto.jpg" alt="Original image before API call" />
<figcaption class="muted">I wonder what this will turn into?</figcaption>
</figure>

<div class="actions">
<button id="loadBtn" type="button">Press for a surprise</button>
<span id="status" class="status" aria-live="polite"></span>
</div>

<table aria-describedby="tableDesc">
<caption id="tableDesc" class="sr-only">Table of cat facts sorted by factId ascending</caption>
<thead>
<tr>
<th scope="col">factId</th>
<th scope="col">fact</th>
</tr>
</thead>
<tbody id="factsBody">
<tr><td colspan="2" class="muted">Click "Press for a surprise" to populate this table.</td></tr>
</tbody>
</table>
</div>

<script>
(function () {
  const btn = document.getElementById('loadBtn');
  const status = document.getElementById('status');
  const img = document.getElementById('catPhoto');
  const tbody = document.getElementById('factsBody');
  const API_URL = 'https://brianobruno.github.io/cats.json';

  function setStatus(msg, isError) {
    status.textContent = msg || '';
    status.className = 'status' + (isError ? ' error' : '');
  }

  function looksLikeImageUrl(value) {
    return typeof value === 'string' && /^(https?:)\/\/\S+\.(png|jpg|jpeg|gif|webp)(\?\S+)?$/i.test(value);
  }

  function extractImageUrl(payload) {
    const candidates = ['catPhoto', 'image', 'img', 'photo', 'picture', 'url'];
    for (const key of candidates) {
      if (looksLikeImageUrl(payload && payload[key])) return payload[key];
    }
    for (const val of Object.values(payload || {})) {
      if (looksLikeImageUrl(val)) return val;
    }
    return null;
  }

  function extractFacts(payload) {
    if (Array.isArray(payload)) return payload;
    if (Array.isArray(payload.facts)) return payload.facts;
    for (const val of Object.values(payload || {})) {
      if (Array.isArray(val) && val.length && typeof val[0] === 'object') {
        const item = val[0];
        if (('factId' in item) && ('fact' in item || 'text' in item)) return val;
      }
    }
    return [];
  }

  async function handleClick() {
    setStatus('Fetching…');
    try {
      const res = await fetch(API_URL, { method: 'GET', headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      const imgUrl = extractImageUrl(data);
      if (imgUrl) {
        img.src = imgUrl;
      }

      const facts = extractFacts(data).slice();
      facts.sort((a, b) => Number(a.factId) - Number(b.factId));

      tbody.innerHTML = '';
      if (facts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="muted">No facts found in API response.</td></tr>';
      } else {
        for (const item of facts) {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td');
          const tdFact = document.createElement('td');
          tdId.textContent = item.factId;
          tdFact.textContent = (item.fact ?? item.text);
          tr.append(tdId, tdFact);
          tbody.appendChild(tr);
        }
      }

      setStatus('Loaded successfully.');
    } catch (err) {
      console.error(err);
      setStatus('Failed to load data: ' + err.message, true);
    }
  }

  btn.addEventListener('click', handleClick);
})();
</script>
</body>
</html>